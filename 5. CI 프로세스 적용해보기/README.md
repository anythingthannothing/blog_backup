## TL;DR

- e2e í…ŒìŠ¤íŠ¸ ì§„í–‰ ì‹œ í”„ë¡œë•ì…˜ ì½”ë“œë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ê¸° ìœ„í•´ ë¹Œë“œ í›„ ì§„í–‰í•˜ë„ë¡ ë³€ê²½í–ˆë‹¤.
- CI í”„ë¡œì„¸ìŠ¤ ì§„í–‰ ì‹œ ë¹Œë“œ Jobì„ ë¨¼ì € ì‹¤í–‰í•˜ê³ , ìœ ë‹›, e2e í…ŒìŠ¤íŠ¸ê°€ ë³‘ë ¬ì ìœ¼ë¡œ ì§„í–‰ë˜ë„ë¡ ë³€ê²½í–ˆë‹¤.
- jest + dockerë¥¼ í™œìš©í•œ e2e í…ŒìŠ¤íŠ¸ ë°©ì‹ì„ ìœ„í•´ typeorm clië¥¼ ì ìš©í–ˆë‹¤.

## í”„ë¡œë•ì…˜ ì½”ë“œë¡œ e2e í…ŒìŠ¤íŠ¸ ì§„í–‰í•˜ê¸°

NestJSì˜ ê¸°ë³¸ì ì¸ í…ŒìŠ¤íŠ¸ í™˜ê²½ì€ ts-jestë¥¼ í™œìš©í•´ì„œ
íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•œë‹¤.
ì´ì— ë”°ë¼ js ì½”ë“œë¡œ ì§„í–‰í•˜ëŠ” í…ŒìŠ¤íŠ¸ ëŒ€ë¹„ ì†ë„ê°€ ë–¨ì–´ì§€ë©°,
íŠ¸ëœìŠ¤íŒŒì¼ëœ ì½”ë“œê°€ ì•„ë‹Œ íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œë¡œ í…ŒìŠ¤íŠ¸ê°€ ì§„í–‰ëœë‹¤ëŠ” ë‹¨ì ì´ ìˆë‹¤.
í…ŒìŠ¤íŠ¸ ë§ˆë‹¤ ë…ë¦½ì ì¸ í™˜ê²½ì„ ë³´ì¥í•˜ê¸° ìœ„í•´ dockerë¥¼ í™œìš©í•´ e2eë¥¼ ì§„í–‰í•˜ì˜€ëŠ”ë°,
ë¹Œë“œ, ë°ì´í„°ë² ì´ìŠ¤ ê´€ë ¨ ì„¤ì •ìœ¼ë¡œ ì¸í•´ e2e í…ŒìŠ¤íŠ¸ë¥¼ ê³§ ë°”ë¡œ ë¹Œë“œ í›„ ì§„í–‰í•˜ê¸°ì—ëŠ” ë¬´ë¦¬ê°€ ìˆì—ˆë‹¤,,,
e2e í…ŒìŠ¤íŠ¸ ì§„í–‰ ë°©ì‹ì„ ë³€ê²½í•˜ë©´ì„œ ë§ˆì£¼ì¹œ ì–´ë ¤ì›€ë“¤ì„ ì •ë¦¬í•´ ë³´ë ¤ê³  í•œë‹¤.

## ë¹Œë“œ ê´€ë ¨ ì„¤ì •

ts-jestëŠ” ë¹Œë“œë¥¼ ì§„í–‰í•˜ì§€ ì•Šê³  íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œë¥¼ í†µí•´ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ê¸° ë•Œë¬¸ì—
ë¹Œë“œë¥¼ í•œ ë’¤ e2e í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ë‹¤ë³´ë©´ ê²½ë¡œ ë¬¸ì œë¡œ ì¸í•´ ì—ëŸ¬ê°€ ë°œìƒí–ˆë‹¤.
![](1.png)
ê¸°ì¡´ configServiceì—ì„œ synchronize ì‹œ ì ìš©í•  entity íŒŒì¼ë“¤ì€
src ì†ŒìŠ¤ì½”ë“œë¥¼ í™œìš©í–ˆëŠ”ë°, ë¹Œë“œë¥¼ ì§„í–‰í•˜ê²Œ ë˜ë©´ì„œ ë°°í¬/ê°œë°œ/í…ŒìŠ¤íŠ¸ í™˜ê²½ ëª¨ë‘
dist í´ë”ì— ìˆëŠ” íŠ¸ëœìŠ¤íŒŒì¼ëœ js ì½”ë“œ ê¸°ë°˜ì˜ entityë¥¼ ê¸°ì¤€ìœ¼ë¡œ synchronizedë˜ë„ë¡ ì„¤ì •ì„ ë³€ê²½í–ˆë‹¤.
![](2.png)
e2e í…ŒìŠ¤íŠ¸ ì§„í–‰ ì‹œ ì ìš©ë˜ëŠ” jest ì„¤ì • íŒŒì¼ ë˜í•œ ts í™•ì¥ìë¥¼ ëª¨ë‘ jsë¡œ ë³€ê²½í–ˆë‹¤.
ë¬¸ì œëŠ” ê¸°ì¡´ì— ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ë˜ typeormì˜ dataSource APIê°€ íŠ¸ëœìŠ¤íŒŒì¼ í›„
ì‹œë“œ ë°ì´í„°ë¥¼ ì‚½ì…í•˜ì§€ ëª»í•˜ëŠ” ë¬¸ì œê°€ ìˆì—ˆë‹¤.
í•´ë‹¹ ë¶€ë¶„ì€ dataSourceì˜ query ë©”ì†Œë“œë¥¼ í†µí•´ ìˆœìˆ˜ ì¿¼ë¦¬ë¬¸ì„ ì‘ì„±í•˜ë‹ˆ ì‰½ê²Œ í•´ê²°í•  ìˆ˜ ìˆì—ˆë‹¤.
ì •í™•í•œ ì›ì¸ì€ íŒŒì•…í•˜ì§€ ëª»í–ˆì§€ë§Œ, ì ì§„ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ migrationì„ í†µí•´
DB ì„¤ì •ì„ ì§„í–‰í•  ì˜ˆì •ì´ì–´ì„œ í° ë¬¸ì œê°€ ë˜ì§€ëŠ” ì•Šì•˜ë‹¤.

```js
test / setup.ts;
// ê¸°ì¡´ ì½”ë“œ
const setup = async () => {
  await dataSource.initialize();

  await dataSource.manager.insert(Role, { role: 'admin' });

  await dataSource.manager.insert(Role, {
    role: 'basic',
  });

  await dataSource.manager.insert(Image, {
    url: 'avatars/default',
  });
};

// ìˆœìˆ˜ SQL ì¿¼ë¦¬ë¥¼ í†µí•œ ë°ì´í„° ì‹œë”©
const setup = async () => {
  await dataSource.initialize();
  await dataSource.manager.query(`INSERT INTO role (role) VALUES ('admin')`);
  await dataSource.manager.query(`INSERT INTO role (role) VALUES ('basic')`);
  await dataSource.manager.query(
    `INSERT INTO image (url) VALUES ('avatars/default')`,
  );
};
```

## í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œì˜ synchronize

typeormì˜ data source api ì¤‘ì—ëŠ” .synchronize ë©”ì„œë“œê°€ ì¡´ì¬í•˜ëŠ”ë°,
Entity íŒŒì¼ì„ ê¸°ë°˜ìœ¼ë¡œ ìŠ¤í‚¤ë§ˆë¥¼ ìë™ìœ¼ë¡œ ì„¤ì •í•´ì£¼ëŠ” ì—­í• ì„ í•œë‹¤.
e2e í…ŒìŠ¤íŠ¸ í™˜ê²½ì„ ìœ„í•´ jestì˜ globalSetup ê¸°ëŠ¥ì„ í™œìš©í•˜ì—¬ DBì— ì—°ê²°ì„ í•œ í›„,
synchronize ë©”ì„œë“œë¥¼ ì ìš©í–ˆìŒì—ë„ ìŠ¤í‚¤ë§ˆ ì‹±í¬ í›„ í…Œì´ë¸”ì´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì§€ ì•Šì•˜ë‹¤.
í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ê¸° ì „ì— schema ì‹±í¬ë¥¼ ë§ì¶”ê¸° ìœ„í•´ì„œëŠ” typeorm clië¥¼ ì´ìš©í•˜ëŠ” ë°©ë²•ì´ ìˆì—ˆë‹¤.
![](3.png)
e2e í…ŒìŠ¤íŠ¸ ì‹œì—ëŠ” ë³„ë„ì˜ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì„ ìƒì„±í•˜ëŠ” ê²ƒë³´ë‹¤ í•´ë‹¹ ëª…ë ¹ì–´ë¥¼ í†µí•´ ì†ì‰½ê²Œ ìŠ¤í‚¤ë§ˆ ì‹±í¬ë¥¼ ë§ì¶œ ìˆ˜ ìˆë‹¤!
ì´ì— ë”°ë¼ setup.js íŒŒì¼ì´ ì‹¤í–‰ë˜ê¸° ì „ì—, í…Œì´ë¸”ì„ ìƒì„±í•˜ê³ 
globalSetupì‹œì—ëŠ” í•„ìš”í•œ ì‹œë“œ ë°ì´í„°ë§Œ ì‚½ì…í•˜ë„ë¡ ë³€ê²½í–ˆë‹¤.
ìŠ¤í¬ë¦½íŠ¸ ë˜í•œ ë‘ ì¤„ë§Œ ì¶”ê°€í•˜ì—¬ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¸íŒ…ì´ ê°€ëŠ¥í–ˆê³ ,
ê¸°ì¡´ e2e í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ì—ëŠ” npm run schema:syncë¥¼ ì¶”ê°€í•´ì¤¬ë‹¤.

```json
//package.json
"test:e2e": "docker compose up -d test-db && npm run schema:sync && NODE_ENV=test jest --config dist/test/jest-e2e.config.js --maxWorkers=1"
"typeorm": "typeorm-ts-node-commonjs",
"schema:sync": "npm run typeorm schema:sync -- -d test/data-source.ts"
```

## CI í”„ë¡œì„¸ìŠ¤ ìˆ˜ì •í•˜ê¸°

e2e í…ŒìŠ¤íŠ¸ ë˜í•œ ë¹Œë“œ í›„ ì§„í–‰í•˜ë„ë¡ ë³€ê²½í•˜ë©´ì„œ ci í”„ë¡œì„¸ìŠ¤ ë˜í•œ ì¼ë¶€ ìˆ˜ì •í–ˆë‹¤.
ê¸°ì¡´ì—ëŠ” unit-test, e2e-test ë‘ ê°œì˜ jobì„ ë³‘ë ¬ì ìœ¼ë¡œ ì‹¤í–‰í•˜ì˜€ëŠ”ë°,
ê³µí†µì ìœ¼ë¡œ í•„ìš”í•œ build í”„ë¡œì„¸ìŠ¤ë¥¼ ë¶„ë¦¬í•˜ì—¬ ì¶”ê°€í•´ì¤¬ë‹¤.
í•„ìš”í•œ ì˜ì¡´ì„±ì„ ìºì‹±í•˜ê³ , ë¹Œë“œëœ ê²°ê³¼ë¬¼ arfifactsë¥¼ ì—…ë¡œë“œ í•œ í›„
ê°ê°ì˜ í…ŒìŠ¤íŠ¸ jobì—ì„œ ë¹Œë“œí•˜ì§€ ì•Šê³  ë‹¤ìš´ë°›ë„ë¡ ìˆ˜ì •í–ˆë‹¤.

```yml
build:
  runs-on: ubuntu-20.04

  steps:
    - name: Get Code from Repository
      uses: actions/checkout@v3

    - name: Use Node.js v.18.
      uses: actions/setup-node@v3
      with:
        node-version: '18.14.2'

    - name: Cache dependencies
      uses: actions/cache@v3
      id: cache-dependencies
      with:
        path: '**/node_modules'
        key: npm-deps-${{ hashFiles('**/package-lock.json') }}

    - name: Install Dependencies
      if: ${{ steps.cache-dependencies.outputs.cache-hit != 'true' }}
      run: npm ci

    - name: Build
      run: npm run build

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts
        path: dist/
```

ë¹Œë“œ ìì²´ì— í° ì‹œê°„ì´ ì†Œìš”ë˜ì§€ ì•ŠëŠ” ìƒíƒœê¸° ë•Œë¬¸ì—
ì˜¤íˆë ¤ ì‹œê°„ì´ ë” ëŠ˜ì–´ë‚  ìˆ˜ë„ ìˆê² ë‹¤ê³  ì˜ˆìƒì€ í–ˆì§€ë§Œ,,,
ì˜ˆìƒë³´ë‹¤ í›¨ì”¬ ë” ì˜¤ëœ ì‹œê°„ì´ ê±¸ë ¸ë‹¤,,,

ê¸°ì¡´ì—ëŠ” ë³‘ë ¬ì ìœ¼ë¡œ ì‹¤í–‰í•œ ê²°ê³¼ ì•½ 1ë¶„ 19ì´ˆê°€ ì†Œìš”ë˜ì—ˆëŠ”ë°
![](5.png)

ë¹Œë“œ jobì„ ê±°ì¹œ í›„ ê° í…ŒìŠ¤íŠ¸ë¥¼ ë³‘ë ¬ì ìœ¼ë¡œ ì‹¤í–‰í–ˆì„ ë•ŒëŠ” 2ë¶„ 15ì´ˆê°€ ê±¸ë ¸ë‹¤.
![](4.png)

buildì— ê±¸ë¦¬ëŠ” ì‹œê°„ì´ ê¸¸ì–´ì§€ê³ , jobì´ ì¦ê°€í•¨ì— ë”°ë¼
artifactë¥¼ ì—…ë¡œë“œí•˜ê³ , ë‹¤ìš´ë¡œë“œ í•˜ëŠ” ê²ƒì´ ì ì  íš¨ìœ¨ì ì´ê²Œ ë˜ê² ì§€ë§Œ
ë¶ˆí•„ìš”í•œ actionë“¤ì´ ìˆëŠ” ì§€ í™•ì¸í•´ ë´ì•¼ê² ë‹¤.
ê·¸ë˜ë„ í…ŒìŠ¤íŠ¸ ë°©ì‹ì„ ì¼ì›í™”í•œ ê±°,
ci í”„ë¡œì„¸ìŠ¤ë¥¼ ì–´ëŠ ì •ë„ ë§ˆë¬´ë¦¬í–ˆë‹¤ëŠ” ê²Œ ê½¤ ë¿Œë“¯í–ˆë‹¤!

Happy Coding! ğŸ˜Š
